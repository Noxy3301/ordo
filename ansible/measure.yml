---
# Measurement-only playbook: run execute sweeps on bench nodes.
- hosts: benchbase
  gather_facts: false
  vars:
    bench_profile: b
    bench_time: 30
    bench_rate: 0
    bench_scalefactor: 10
    bench_terms: [1, 32, 64, 96, 128, 160, 192, 224, 256]
    haproxy_host: "{{ hostvars['haproxy-1'].private_ip }}"
    haproxy_port: 3307
  tasks:
    - name: Run with fixed-terminal
      shell: |
        cd ~/ordo
        ./scripts/run_dist.sh \
          --profile {{ bench_profile }} \
          --time {{ bench_time }} \
          --rate {{ bench_rate }} \
          --scalefactor {{ bench_scalefactor }} \
          --mysql-host {{ haproxy_host }} \
          --mysql-port {{ haproxy_port }} \
          --terminals {{ item }}
        f=$(ls -td bench/results/_run_dist/* 2>/dev/null | head -n1)
        tail -n1 "$f/summary.csv"
      args: { executable: /bin/bash }
      loop: "{{ bench_terms }}"
      register: run_summaries
      loop_control:
        label: "{{ item }}"

    - name: Show summary lines (numeric last line only)
      debug:
        msg: "{{ item.item }} => {{ (item.stdout_lines | select('match','^[0-9]') | list | last) | default(item.stdout | trim) }}"
      loop: "{{ run_summaries.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Ensure throughput result dir
      delegate_to: localhost
      run_once: true
      vars:
        machine_spec: "{{ hostvars[groups['benchbase'][0]].machine_spec | default('unknown') }}"
        throughput_dir: "{{ playbook_dir }}/result/{{ machine_spec }}/throughput"
      file:
        path: "{{ throughput_dir }}"
        state: directory

    - name: Write throughput raw csv
      delegate_to: localhost
      run_once: true
      vars:
        machine_spec: "{{ hostvars[groups['benchbase'][0]].machine_spec | default('unknown') }}"
        throughput_dir: "{{ playbook_dir }}/result/{{ machine_spec }}/throughput"
      copy:
        dest: "{{ throughput_dir }}/throughput_raw.csv"
        content: |
          {% for host in groups['benchbase'] %}
          {% for item in (hostvars[host].run_summaries.results | default([])) %}
          {% set line = (item.stdout_lines | select('match','^[0-9]') | list | last) | default(item.stdout | trim) %}
          {% if line %}
          {{ host }},{{ line }}
          {% endif %}
          {% endfor %}
          {% endfor %}
